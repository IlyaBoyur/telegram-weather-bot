# telegram-weather-bot


## Технологии
Python3.10, python-telegram-bot, tablib, flake8, pytest, pymongo


## Сторонние сервисы
Геолокация пользователя - [Яндекс.Геокодер](https://yandex.ru/dev/maps/geocoder/)

Прогноз - [API Яндекс.Погоды](https://yandex.ru/dev/weather/)


## Описание
Проект представляет собой телеграм бот, который:
* сообщает, какая погода рядом с пользователем (/my_weather)
* смотрит, какая погода в городе по названию города (/get_weather)
* рассчитывает, где сейчас наиболее благоприятная погода: топ 1, топ 3, топ 5 городов. (/best_weather)

Для простоты проекта, список городов находится в переменной `CITIES` в файле [utils.py](utils.py).

Анализ данных ведется по погодным условиям, полученным от API Яндекс Погоды.


### Способ расчета рейтинга для города
- период вычислений в течение дня — с 9 до 19 часов;
- средняя температура рассчитывается за указанный промежуток времени;
- сумма времени (часов), когда погода благоприятная: без осадков (без дождя, снега, града или грозы) и в интервале +18 ... +27, рассчитывается за указанный промежуток времени;

Результат возвращается пользователю в текстовом файле.

Формат сохраняемого файла - **json**, **csv** или **xls/xlsx**.

Формат таблицы, где рейтинг — это позиция города относительно других при анализе «благоприятности поездки»:

| Город/день  |                           | 14-06 | ... | 19-06 | Среднее | Рейтинг |
|-------------|:--------------------------|:-----:|:---:|:-----:|--------:|--------:|
| Москва      | Температура, среднее      |  24   |     |  27   |    25.6 |       8 |
|             | Без осадков, часов        |   8   |     |   4   |       6 |         |
| Абу-Даби    | Температура, среднее      |  34   |     |  37   |    35.5 |       2 |
|             | Без осадков, часов        |   9   |     |  10   |     9.5 |         |
| ...         |                           |       |     |       |         |         |


Выше рейтинг у того города, в котором средняя температура за всё время была самой высокой, а количество часов благоприятной погоды — максимальное.


## Реализация
1. Для решения используются как процессы, так и потоки.
2. Для решения используются как очередь, так и пул задач.
3. Этапы решения описаны в виде отдельных классов в модуле [tasks.py](tasks.py):
  - `GeoDataFetchingTask`  — получение данных через API Яндекс Геокодера;
  - `GeoDataParsingTask` — обработка данных и получение геолокации объекта;
  - `DataFetchingTask` — получение данных через API Яндекс Погоды;
  - `DataCalculationTask` — вычисление погодных параметров;
  - `DataAggregationTask` — объединение вычисленных данных;
  - `DataAnalyzingTask` — финальный анализ и получение результата.


## Пример использования `YandexWeatherAPI` для работы с API
```python
from api_client import YandexWeatherAPI
from city_repository import CityRepository


ywAPI = YandexWeatherAPI(city_service=CityRepository.from_csv())
city_name = "MOSCOW"
response = ywAPI.get_forecasting(city_name)
```


## Быстрый старт
### 1) Добавить файл переменных среды
Примеры переменных в файле [.env.example](.env.example) в корне проекта


### 2) Установить локальное окружение
```shell
$ python3 -m venv venv
$ venv/bin/activate # Windows (Git Bash): source venv/Scripts/activate
```


### 3) Установить зависимости
```shell
$ pip install -r requirements.txt
```


### 4) Запуск базы данных
```shell
# в корне проекта
$ docker compose up -d --remove-orphans
```

### 5) Запуск
```shell
# в корне проекта
$ python3 bot.py
```
```forecasts.xls``` в папке проекта содержит результат анализа по команде боту `/best_weather`


## Авторы
[Илья Боюр](https://github.com/IlyaBoyur)


